

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="title: CS144-networkP695-2NATs.md100:00:00,000 –&gt; 00:00:06,000So in this video, I’m going to go over all the different kinds of gnats, or not all of them, many of the different kinds of gnats that">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2025/10/23/CS144-networkP695-2NATs/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="title: CS144-networkP695-2NATs.md100:00:00,000 –&gt; 00:00:06,000So in this video, I’m going to go over all the different kinds of gnats, or not all of them, many of the different kinds of gnats that">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-23T00:14:54.862Z">
<meta property="article:modified_time" content="2025-10-23T00:16:16.955Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text=""></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-10-23 08:14" pubdate>
          2025年10月23日 早上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          1.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          12 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header"></h1>
            
            
              <div class="markdown-body">
                
                <hr>
<h2 id="title-CS144-networkP695-2NATs-md"><a href="#title-CS144-networkP695-2NATs-md" class="headerlink" title="title: CS144-networkP695-2NATs.md"></a>title: CS144-networkP695-2NATs.md</h2><p>1<br>00:00:00,000 –&gt; 00:00:06,000<br>So in this video, I’m going to go over all the different kinds of gnats, or not all of them, many of the different kinds of gnats that exist.</p>
<p>2<br>00:00:06,000 –&gt; 00:00:13,000<br>So it seems like a very simple abstraction of translating addresses from an internal to an external interface.</p>
<p>3<br>00:00:13,000 –&gt; 00:00:16,000<br>Well, it turns out there’s all kinds of different ways you might implement that.</p>
<p>4<br>00:00:16,000 –&gt; 00:00:25,000<br>And a lot of them are deployed out in the wild, and understanding these differences gives you a sense then of why gnats can be such a complicating factor when building applications.</p>
<p>5<br>00:00:25,000 –&gt; 00:00:36,000<br>So recalls the model of a gnat is that, or generally the way it works, is that when there’s some kind of communication from a node behind the gnat to an external node on the internet,</p>
<p>6<br>00:00:36,000 –&gt; 00:00:53,000<br>the gnats sets up an internal mapping between the, a napping you internally did, and it’s in its memory, between an internal IP address and associated port to an external IP address and port.</p>
<p>7<br>00:00:53,000 –&gt; 00:01:17,000<br>And so when this server A tries to open a connection to the web server on S at 1818180131, so it’s going to port 80 on this host, and it’s coming from port 4512, the gnat rewrites that route, that say all of those packets, including TCP San, and then all the data packets, to be coming from its own IP address and port 6641.</p>
<p>8<br>00:01:17,000 –&gt; 00:01:24,000<br>That’s at the server sees, and then when the server sends messages back, the gnat translates them back to port 4512.</p>
<p>9<br>00:01:24,000 –&gt; 00:01:33,000<br>So that’s the simple model, and there are two basic questions that come up. First is, what packets doesn’t not allow to traverse these mappings?</p>
<p>10<br>00:01:33,000 –&gt; 00:01:41,000<br>The second is, how and when does a gnat assign these mappings? When does it create them? So I said when you generate packets, but turns out it can be a little more complicated than that.</p>
<p>11<br>00:01:41,000 –&gt; 00:01:52,000<br>When does it tear down those mappings? It doesn’t keep them mapping forever. So it turns out there’s a nice RFC that sort of goes through some classifications in terminology I’m going to use in the rest of this video, 3489.</p>
<p>12<br>00:01:52,000 –&gt; 00:01:59,000<br>So if we want to read a little bit more about some details, I’m going to precise weight these are laid out. Take a look at RFC 3489.</p>
<p>13<br>00:01:59,000 –&gt; 00:02:07,000<br>So the first kind of gnat is what’s called a full cone gnat, and this in some ways is the one that plays the nicest.</p>
<p>14<br>00:02:07,000 –&gt; 00:02:17,000<br>And a full coneat is called that because it is the least restrictive in terms of what packets it allows to traverse a mapping.</p>
<p>15<br>00:02:17,000 –&gt; 00:02:24,000<br>And that way it’s a full cone and the things which are allowed in are large.</p>
<p>16<br>00:02:24,000 –&gt; 00:02:43,000<br>And so the basic model of a full coneat is that any packet that say this is for the particular, say, particle TCP, any TCP packet that comes into the gnat to this IP address, port pair, will be translated to this IP address, this port pair.</p>
<p>17<br>00:02:43,000 –&gt; 00:02:59,000<br>Regardless of what the source address and source port are, this is the least restrictive. So if I have some other server, say S2, that has some IP address A, and it’s sending a packet from port A prime.</p>
<p>18<br>00:02:59,000 –&gt; 00:03:22,000<br>And that packet with source port A prime is sent to 1283422.8 port 6641, the gnat will translate it. And my server, my host here, will see something coming from A prime arriving at port 10.0.0.01 port 4512.</p>
<p>19<br>00:03:22,000 –&gt; 00:03:30,000<br>Now it might discard that packet, it might send an ICMP error, but the point is that not will do the translation. It’s the least restrictive. It’s a full cone.</p>
<p>20<br>00:03:30,000 –&gt; 00:03:40,000<br>So in addition to full conenads, there are also restricted conenads. And what restricted conenads does is it filters based on the source IP address.</p>
<p>21<br>00:03:40,000 –&gt; 00:03:51,000<br>So when restricted conenads, the gnat will translate packets that come from the same source address as intended on the external mapping.</p>
<p>22<br>00:03:51,000 –&gt; 00:04:04,000<br>So when the gnat sets up the mapping between the internal address and port pair and the external address and port pair, it includes the address of the other endpoint.</p>
<p>23<br>00:04:05,000 –&gt; 00:04:23,000<br>And so in this case, if I have S2, which tries to send a packet from A colon A prime address A, A prime, the gnat will not allow that packet to traverse. It will discard that it will either send an ICMP error or generally will not translate that packet and host A will never see it.</p>
<p>24<br>00:04:24,000 –&gt; 00:04:42,000<br>However, if server S were to send a packet from IP address S, and then let’s just say port, say port near 10,099, that will be able to traverse the mapping in the sense of it’s coming from 18.1.0.01.31.</p>
<p>25<br>00:04:42,000 –&gt; 00:04:54,000<br>And so host A will see a packet from 18.1.0.31.1099. And it will come in destined to 10.0.0.01.4512.</p>
<p>26<br>00:04:54,000 –&gt; 00:04:59,000<br>So that’s a restricted conenad. It will filter based on the IP address but not the port.</p>
<p>27<br>00:04:59,000 –&gt; 00:05:08,000<br>So the last kind of a gnat or these three major classification is a port restricted net where it behaves like a restricted cone except it also filters on port.</p>
<p>28<br>00:05:08,000 –&gt; 00:05:23,000<br>So in this case, when a packet comes in from some external host to 128, 34, 22, 8, 6641, the gnat is storing also what the expected IP address and port are.</p>
<p>29<br>00:05:23,000 –&gt; 00:05:32,000<br>So in this case, if I again, I have some server S2 that tries to send something from A, A prime, the gnat will not translate that that’s seen as an error in ICMP etc.</p>
<p>30<br>00:05:32,000 –&gt; 00:05:37,000<br>No route to host whatever error it thinks is correct to specify, depending on the conditions.</p>
<p>31<br>00:05:37,000 –&gt; 00:05:50,000<br>But similarly, if server S tries to send a message from port 10,099, that will not traverse either because it doesn’t match the port in the mapping.</p>
<p>32<br>00:05:50,000 –&gt; 00:06:01,000<br>So only packets from this IP address port pair 18181 031 port 80 will be allowed to translate to 10.0.0.0.1.4512.</p>
<p>33<br>00:06:01,000 –&gt; 00:06:08,000<br>So only this particular pair can traverse the mapping.</p>
<p>34<br>00:06:08,000 –&gt; 00:06:13,000<br>So the last and the final kind of gnat is something called a symmetric gnat.</p>
<p>35<br>00:06:13,000 –&gt; 00:06:20,000<br>And what makes a symmetric gnat different is not only is that first of all, it’s sort of by definition port restricted.</p>
<p>36<br>00:06:20,000 –&gt; 00:06:36,000<br>But there’s the fact that packets coming from the same source address and port internal to the gnat that are going to different destination addresses and ports are given different external address port mappings.</p>
<p>37<br>00:06:37,000 –&gt; 00:06:39,000<br>So if you look at this figure, I’ll see what I’m saying.</p>
<p>38<br>00:06:39,000 –&gt; 00:06:47,000<br>So here, I have host A and it’s sending packets from 10.0.0.1.1.4512.</p>
<p>39<br>00:06:47,000 –&gt; 00:06:52,000<br>And first, it’s sending them to 18181 031 port 3311.</p>
<p>40<br>00:06:52,000 –&gt; 00:06:54,000<br>So the gnat sets up a mapping.</p>
<p>41<br>00:06:54,000 –&gt; 00:07:05,000<br>And the mapping between this internal address port pair and this internal address port pair is 128342286641.</p>
<p>42<br>00:07:06,000 –&gt; 00:07:17,000<br>And so packets that A sends to port 3311 on this IP address will be translated to have this IP address in this port.</p>
<p>43<br>00:07:17,000 –&gt; 00:07:25,000<br>However, if A sends packets to a different external IP address and port, like let’s say even the same port and IP address is differs in one bit.</p>
<p>44<br>00:07:25,000 –&gt; 00:07:31,000<br>So it’s also sending packets to S prime of 18181 032 port 3311.</p>
<p>45<br>00:07:31,000 –&gt; 00:07:33,000<br>The gnat sets up a completely different mapping.</p>
<p>46<br>00:07:33,000 –&gt; 00:07:48,000<br>So even though this port address pair is the same for both of these streams of packets, the fact that the destination port address pair is different means the gnat sets up a separate mapping.</p>
<p>47<br>00:07:48,000 –&gt; 00:07:54,000<br>Sixth port 6641 and port 9821.</p>
<p>48<br>00:07:54,000 –&gt; 00:08:16,000<br>So different destinations receive different mappings.</p>
<p>49<br>00:08:16,000 –&gt; 00:08:22,000<br>So it turns out that, and this is just to give you one concrete example of ways in which gnats can really disrupt applications.</p>
<p>50<br>00:08:22,000 –&gt; 00:08:27,000<br>So let’s pretend that host A is sending UDP traffic.</p>
<p>51<br>00:08:27,000 –&gt; 00:08:32,000<br>And this UDP traffic is for a massively multiplayer online game.</p>
<p>52<br>00:08:32,000 –&gt; 00:08:33,000<br>So this is a true story.</p>
<p>53<br>00:08:33,000 –&gt; 00:08:36,000<br>A friend of mine was working on the servers for this one that happened.</p>
<p>54<br>00:08:36,000 –&gt; 00:08:41,000<br>It’s back in the late 90s and he made an angry call at the Linux gnat developers.</p>
<p>55<br>00:08:41,000 –&gt; 00:08:50,000<br>And so the issue is that this massively multiplayer game runs on many servers and there’s times when somebody runs from one island to another and they need to change the server they’re on.</p>
<p>56<br>00:08:50,000 –&gt; 00:09:00,000<br>And so what the system would do is we would tell the client, oh, okay, hey, you’ve been talking to server 18181 031.</p>
<p>57<br>00:09:00,000 –&gt; 00:09:06,000<br>You should start talking to a server S prime at 1818181 032 on this port.</p>
<p>58<br>00:09:06,000 –&gt; 00:09:09,000<br>Even the same part doesn’t matter.</p>
<p>59<br>00:09:09,000 –&gt; 00:09:10,000<br>Like here, say port 3311.</p>
<p>60<br>00:09:10,000 –&gt; 00:09:12,000<br>Both of them are going to talk port 3311.</p>
<p>61<br>00:09:12,000 –&gt; 00:09:17,000<br>So hey, please start talking on this other to this other host.</p>
<p>62<br>00:09:17,000 –&gt; 00:09:22,000<br>And the issue is that the gnat, this symmetric gnat, would create a new mapping.</p>
<p>63<br>00:09:22,000 –&gt; 00:09:26,000<br>And so S was seeing the client covering important 6641.</p>
<p>64<br>00:09:26,000 –&gt; 00:09:30,000<br>But now suddenly the client is covering from port 9821.</p>
<p>65<br>00:09:30,000 –&gt; 00:09:38,000<br>And there was no way for the system back here to know that because the gnat just sets this up and it can arbitrarily decide so the connection breaks.</p>
<p>66<br>00:09:38,000 –&gt; 00:09:45,000<br>So the observed behavior with that because there was a symmetric gnat that whenever someone would try to migrate from one server to another, they would disconnect.</p>
<p>67<br>00:09:45,000 –&gt; 00:09:48,000<br>So here’s an example of by adding this smarts into the network.</p>
<p>68<br>00:09:48,000 –&gt; 00:09:55,000<br>Suddenly you’re seeing a behavior different from the simple, you know, strong end to end argument.</p>
<p>69<br>00:09:55,000 –&gt; 00:10:01,000<br>And there’s this added behavior, which is really hard to manage and really hard to take into consideration.</p>
<p>70<br>00:10:01,000 –&gt; 00:10:07,000<br>Because there’s no way really for S prime to know the port 9821 is the port that is going to start communicating on.</p>
<p>71<br>00:10:07,000 –&gt; 00:10:12,000<br>So there’s just the most basic overview of some ways in which gnats can differ in their behavior.</p>
<p>72<br>00:10:12,000 –&gt; 00:10:16,000<br>Turns out that there is many more complications, all kinds of different things gnats could do.</p>
<p>73<br>00:10:16,000 –&gt; 00:10:23,000<br>And at that RFC I mentioned earlier, in fact goes through all the really diverse behaviors you saw when gnats first became popular.</p>
<p>74<br>00:10:23,000 –&gt; 00:10:26,000<br>Before there is really standardization of what should happen.</p>
<p>75<br>00:10:26,000 –&gt; 00:10:28,000<br>There’s all kinds of things like static mapping.</p>
<p>76<br>00:10:28,000 –&gt; 00:10:36,000<br>You can tell the gnat hey, just set up this static mapping between the external host IP port pair, my external IP address and port, then to an internal one.</p>
<p>77<br>00:10:36,000 –&gt; 00:10:42,000<br>This is say if you have a web server behind your night, you can tell it, hey, anything that comes to port 84 to this server on port 80.</p>
<p>78<br>00:10:42,000 –&gt; 00:10:44,000<br>You have things like triggers.</p>
<p>79<br>00:10:44,000 –&gt; 00:10:48,000<br>If you see packets going out in one direction, then also set up this additional mapping.</p>
<p>80<br>00:10:48,000 –&gt; 00:10:55,000<br>This is really useful in some of the early days of first person shooters online games where again they hadn’t been built in gnats in mind.</p>
<p>81<br>00:10:55,000 –&gt; 00:10:57,000<br>There’s really diverse gnats behavior.</p>
<p>82<br>00:10:57,000 –&gt; 00:11:00,000<br>There’s all kinds of more complex things that happen.</p>
<p>83<br>00:11:00,000 –&gt; 00:11:08,000<br>But so it turns out because of all the headaches and messes that gnats are creating applications, the IETF1 and came up with a bunch of recommendations to how gnats should behave.</p>
<p>84<br>00:11:08,000 –&gt; 00:11:17,000<br>So the general behavioral recommendations specified in RFC 53.82 for TCP and 47.87 for UDP.</p>
<p>85<br>00:11:18,000 –&gt; 00:11:41,000<br>So just to give you one example of some of the weird edge cases that a gnat can consider and some of the things that are specified here, I’m going to talk about hairpinning, which is this process of what happens when you have a node that’s behind your gnat, and it sends a packet to one of the external interface port pairs that the gnat has, one of its mappings.</p>
<p>86<br>00:11:41,000 –&gt; 00:11:48,000<br>So basically I have a node that’s behind the gnat and is trying to traverse one of the gnats mappings.</p>
<p>87<br>00:11:48,000 –&gt; 00:11:58,000<br>So here’s the example. I have this gnat, 128, 34, 22.8, and I have host A and B that are behind the gnat, and they’re both connected to a switch.</p>
<p>88<br>00:11:59,000 –&gt; 00:12:04,000<br>So A has address 10, 0, 0, 1, 1, B has 10, 0, 0, 99.</p>
<p>89<br>00:12:04,000 –&gt; 00:12:13,000<br>Now let’s say we’re doing some kind of IP telephony, which is coming from port, this is UDP traffic, so it’s port 4512 on host A.</p>
<p>90<br>00:12:13,000 –&gt; 00:12:20,000<br>So it’s using port 4512, and this is translated to port 6641 on the gnat.</p>
<p>91<br>00:12:21,000 –&gt; 00:12:32,000<br>So the question is what happens when B tries to send traffic to 128, 34, 22.8, port 6641?</p>
<p>92<br>00:12:32,000 –&gt; 00:12:38,000<br>There’s a question, so the gnat is going to arrive with a gnat, and the gnat is going to translate it.</p>
<p>93<br>00:12:38,000 –&gt; 00:12:44,000<br>It’s going to translate this, assuming that it is a full cone gnat.</p>
<p>94<br>00:12:44,000 –&gt; 00:12:49,000<br>It’s going to translate this to 10.0.101 port 4512.</p>
<p>95<br>00:12:50,000 –&gt; 00:12:57,000<br>One question you can ask is that, well, it’s going to translate the destination IP address in port.</p>
<p>96<br>00:12:57,000 –&gt; 00:13:01,000<br>What should it do to the source IP address in port? Should it translate that as well?</p>
<p>97<br>00:13:01,000 –&gt; 00:13:12,000<br>That is, should this packet arrive at A, seemingly coming from 128, 34, 22.8, or should this packet arrive at A, coming from 10.0.0.99?</p>
<p>98<br>00:13:13,000 –&gt; 00:13:20,000<br>Well, so let’s walk through what happens if the gnat doesn’t translate the source IP address in port.</p>
<p>99<br>00:13:20,000 –&gt; 00:13:29,000<br>So this packet will go through the switch, it’ll go to the gnat, then that will rewrite it to be going to 10.0.101 to 4512.</p>
<p>100<br>00:13:29,000 –&gt; 00:13:37,000<br>And so what A will see is a packet with source 10.0.0.99, let’s just say port X doesn’t really matter.</p>
<p>101<br>00:13:38,000 –&gt; 00:13:44,000<br>I’m destination 10.0.0.101 port 4512.</p>
<p>102<br>00:13:44,000 –&gt; 00:13:48,000<br>And let’s say it likes this packet, it wants to respond, and it sends a response.</p>
<p>103<br>00:13:48,000 –&gt; 00:13:51,000<br>That packet is never going to reach the gnat.</p>
<p>104<br>00:13:51,000 –&gt; 00:13:55,000<br>It’s going to possibly go directly through the switch.</p>
<p>105<br>00:13:55,000 –&gt; 00:13:58,000<br>And because it doesn’t go through the gnat, it’s not going to be translated.</p>
<p>106<br>00:13:59,000 –&gt; 00:14:12,000<br>So B is going to send a packet to 128, 34, 22.8, port 6641, and we’ll see in response a packet from 10.0.0.101 to 4512.</p>
<p>107<br>00:14:12,000 –&gt; 00:14:15,000<br>So this breaks. This is not what you want to do.</p>
<p>108<br>00:14:15,000 –&gt; 00:14:20,000<br>Instead, when this packet goes up to the gnat, the gnat needs to translate it.</p>
<p>109<br>00:14:20,000 –&gt; 00:14:44,000<br>So it comes in as a packet from, so source 10.0.0.99 port X destination 128 34 22.8 6641 needs to be rewritten to be source 128.34.22.8 with some port let’s just call it X prime.</p>
<p>110<br>00:14:45,000 –&gt; 00:14:51,000<br>Descination 10.0.0.101 port 4512.</p>
<p>111<br>00:14:51,000 –&gt; 00:15:00,000<br>And by so doing then, because now the source is coming from the gnat, when A sends a response, it’ll go back up the gnat, where the gnat can re-translate it, and forward it back to B.</p>
<p>112<br>00:15:00,000 –&gt; 00:15:05,000<br>So it’s called hairpinning through the model because you have to actually go back through this device, sort of like a hairpin.</p>
<p>113<br>00:15:05,000 –&gt; 00:15:09,000<br>It comes back from telephony networks as the terminology.</p>
<p>114<br>00:15:09,000 –&gt; 00:15:13,000<br>And so here’s this example of a very specific behavior the gnat has to have.</p>
<p>115<br>00:15:13,000 –&gt; 00:15:22,000<br>And if it doesn’t, then this little edge case where B ends up sending a packet to A based on an external mapping, if you don’t do this, it will break.</p>
<p>116<br>00:15:22,000 –&gt; 00:15:29,000<br>So this is just one of the many tricky edge cases that gnat introduce, gnats introduce, and which are specified in these RFCs.</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div></div>
      <div>http://example.com/2025/10/23/CS144-networkP695-2NATs/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年10月23日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/10/23/CS144-networkP705-3NATs/" title="">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/10/23/CS144-networkP685-1NATs/" title="">
                        <span class="hidden-mobile"></span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
