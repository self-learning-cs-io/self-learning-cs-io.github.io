

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="100:00:00,000 –&gt; 00:00:06,000So, that’s provided a really useful service. They allow you to share an IP address among many hosts, 200:00:06,000 –&gt; 00:00:10,000which is useful today given that IP">
<meta property="og:type" content="article">
<meta property="og:title" content="CS144 NetworkP705 3NATs">
<meta property="og:url" content="http://example.com/2025/10/23/CS144-networkP705-3NATs/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="100:00:00,000 –&gt; 00:00:06,000So, that’s provided a really useful service. They allow you to share an IP address among many hosts, 200:00:06,000 –&gt; 00:00:10,000which is useful today given that IP">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-23T14:13:16.954Z">
<meta property="article:modified_time" content="2025-10-23T14:13:54.953Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>CS144 NetworkP705 3NATs - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CS144 NetworkP705 3NATs"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-10-23 22:13" pubdate>
          2025年10月23日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          1.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          14 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CS144 NetworkP705 3NATs</h1>
            
            
              <div class="markdown-body">
                
                <p>1<br>00:00:00,000 –&gt; 00:00:06,000<br>So, that’s provided a really useful service. They allow you to share an IP address among many hosts,</p>
<p>2<br>00:00:06,000 –&gt; 00:00:10,000<br>which is useful today given that IP addresses are becoming more scarce.</p>
<p>3<br>00:00:10,000 –&gt; 00:00:16,000<br>They also can provide some other useful services such as a limited degree of security and firewalling.</p>
<p>4<br>00:00:16,000 –&gt; 00:00:19,000<br>So, there are a lot of implications to what happens in your behind-and-out.</p>
<p>5<br>00:00:19,000 –&gt; 00:00:24,000<br>So, this video is going to go into what some of those implications are and how some modern applications today</p>
<p>6<br>00:00:24,000 –&gt; 00:00:26,000<br>try to deal with them when they’re obstructions.</p>
<p>7<br>00:00:26,000 –&gt; 00:00:31,000<br>So, the first application of an network address translator is that generally speaking,</p>
<p>8<br>00:00:31,000 –&gt; 00:00:35,000<br>incoming connections, you can’t have an incoming connection.</p>
<p>9<br>00:00:35,000 –&gt; 00:00:38,000<br>So, we saw this back when we talked about Skype.</p>
<p>10<br>00:00:38,000 –&gt; 00:00:43,000<br>What happens is when you want to open a call, somebody’s behind-and-out, you can’t directly open a TCP connection to them,</p>
<p>11<br>00:00:43,000 –&gt; 00:00:47,000<br>because there’s no mapping. So, let’s walk through how that works.</p>
<p>12<br>00:00:47,000 –&gt; 00:00:53,000<br>So, here we have an SSH server or we have a server sitting behind-and-out.</p>
<p>13<br>00:00:53,000 –&gt; 00:00:56,000<br>Here’s server A.</p>
<p>14<br>00:00:56,000 –&gt; 00:01:01,000<br>And it has, it happens to be running a SSH server on import 22.</p>
<p>15<br>00:01:01,000 –&gt; 00:01:06,000<br>And it has, you know, open a connection to this server S, it’s browsing the web.</p>
<p>16<br>00:01:06,000 –&gt; 00:01:09,000<br>You know, it does a web connection, this is great.</p>
<p>17<br>00:01:09,000 –&gt; 00:01:20,000<br>So, now, what happens when host B wants to open a SSH connection to host A?</p>
<p>18<br>00:01:20,000 –&gt; 00:01:24,000<br>Well, the problem is it’s going to be sending a packet to this NAT.</p>
<p>19<br>00:01:24,000 –&gt; 00:01:35,000<br>And whatever happens, somehow this packet needs to be translated to be going to 10.0.0.101 or 22.</p>
<p>20<br>00:01:35,000 –&gt; 00:01:39,000<br>But there’s no mapping for that. SSH is a server.</p>
<p>21<br>00:01:39,000 –&gt; 00:01:43,000<br>It doesn’t issue connection requests out. It receives connection requests.</p>
<p>22<br>00:01:43,000 –&gt; 00:01:45,000<br>And so, the NAT has no mapping.</p>
<p>23<br>00:01:45,000 –&gt; 00:01:50,000<br>And so, because there’s no mapping to 10.0.0.101.22,</p>
<p>24<br>00:01:50,000 –&gt; 00:01:54,000<br>B effectively can’t open a SSH connection.</p>
<p>25<br>00:01:54,000 –&gt; 00:02:02,000<br>Right? The NAT allows connections out. It does not allow connections in.</p>
<p>26<br>00:02:02,000 –&gt; 00:02:05,000<br>And so, this poses all kinds of complications for applications.</p>
<p>27<br>00:02:05,000 –&gt; 00:02:08,000<br>Where, you know, what happens if say I’m running Skype,</p>
<p>28<br>00:02:08,000 –&gt; 00:02:11,000<br>and I would like to make a phone call. If the other nodes behind the NAT,</p>
<p>29<br>00:02:11,000 –&gt; 00:02:13,000<br>I can’t open a connection to that node.</p>
<p>30<br>00:02:13,000 –&gt; 00:02:16,000<br>And so, it really restricts the kinds of services that you can deploy.</p>
<p>31<br>00:02:16,000 –&gt; 00:02:20,000<br>And you have to jump through a bunch of hoops in order to make applications work</p>
<p>32<br>00:02:20,000 –&gt; 00:02:24,000<br>when they’re setting behind NATs.</p>
<p>33<br>00:02:24,000 –&gt; 00:02:28,000<br>But so, this is the number one implication of setting behind a NAT to an application,</p>
<p>34<br>00:02:28,000 –&gt; 00:02:32,000<br>which is that essentially if you’re behind a NAT, generally speaking,</p>
<p>35<br>00:02:32,000 –&gt; 00:02:36,000<br>other nodes unless you coordinate very carefully, and I’ll show some ways you can do it,</p>
<p>36<br>00:02:36,000 –&gt; 00:02:39,000<br>you can’t open, nobody can open a connection to you.</p>
<p>37<br>00:02:39,000 –&gt; 00:02:43,000<br>So, the first approach and talked about this briefly in the Skype lecture before</p>
<p>38<br>00:02:43,000 –&gt; 00:02:47,000<br>is something called connection reversal. So, imagine that A is sitting behind a NAT,</p>
<p>39<br>00:02:47,000 –&gt; 00:02:53,000<br>and B wants to open a connection to A.</p>
<p>40<br>00:02:53,000 –&gt; 00:02:57,000<br>Well, B can’t because the NAT has no mapping, these packs will bounce off.</p>
<p>41<br>00:02:57,000 –&gt; 00:02:59,000<br>You know, bounce off, you get ICMP errors.</p>
<p>42<br>00:02:59,000 –&gt; 00:03:03,000<br>And so, what you can do is have some kind of reversal services,</p>
<p>43<br>00:03:03,000 –&gt; 00:03:08,000<br>some kind of rendezvous service, where both A and B are connected to the rendezvous service.</p>
<p>44<br>00:03:08,000 –&gt; 00:03:14,000<br>And when B wants to open a connection to A, what it actually sends is it sends a request,</p>
<p>45<br>00:03:14,000 –&gt; 00:03:22,000<br>hey, A, I want a connection.</p>
<p>46<br>00:03:22,000 –&gt; 00:03:29,000<br>The rendezvous service can forward this request on, then A can open a connection to B.</p>
<p>47<br>00:03:29,000 –&gt; 00:03:34,000<br>So, it’s called connection reversal, because B wants to open a connection to A,</p>
<p>48<br>00:03:34,000 –&gt; 00:03:38,000<br>but because it can’t, because the NAT, so instead you reverse the connection,</p>
<p>49<br>00:03:38,000 –&gt; 00:03:40,000<br>have A open a connection to B.</p>
<p>50<br>00:03:40,000 –&gt; 00:03:44,000<br>And to do this, you need some kind of rendezvous service that two can communicate,</p>
<p>51<br>00:03:44,000 –&gt; 00:03:49,000<br>but they both open outgoing connections. rendezvous service, and then requests are forward in that way.</p>
<p>52<br>00:03:49,000 –&gt; 00:03:52,000<br>So, this is for example one of the things that Skype does.</p>
<p>53<br>00:03:52,000 –&gt; 00:03:56,000<br>So, another approach, and there’s also what Skype does, is if both hosts are behind a NAT,</p>
<p>54<br>00:03:56,000 –&gt; 00:04:02,000<br>well, this means that neither of them can directly open a connection to the other.</p>
<p>55<br>00:04:02,000 –&gt; 00:04:07,000<br>In both cases, the connection request will fail. There’s no mapping on the NAT,</p>
<p>56<br>00:04:07,000 –&gt; 00:04:09,000<br>generally speaking, and so it fails.</p>
<p>57<br>00:04:09,000 –&gt; 00:04:21,000<br>So, instead, as you have both of them, connect to some relay R.</p>
<p>58<br>00:04:21,000 –&gt; 00:04:25,000<br>And then the relay R, forwards traffic between those two connections.</p>
<p>59<br>00:04:25,000 –&gt; 00:04:31,000<br>So, data that streams in from A’s connection, R receives, then forwards to the connection to B,</p>
<p>60<br>00:04:31,000 –&gt; 00:04:35,000<br>data that comes in from B’s connection, R receives and forwards to A.</p>
<p>61<br>00:04:35,000 –&gt; 00:04:38,000<br>But here’s an example of suddenly this is no longer end to end.</p>
<p>62<br>00:04:38,000 –&gt; 00:04:42,000<br>We now have introduced this additional host in the center, and who knows what could go wrong.</p>
<p>63<br>00:04:42,000 –&gt; 00:04:46,000<br>So, certainly if you’re doing this, it’s good to encrypt your traffic,</p>
<p>64<br>00:04:46,000 –&gt; 00:04:48,000<br>unless you trust the relay.</p>
<p>65<br>00:04:48,000 –&gt; 00:04:52,000<br>But there’s a way where if both hosts are behind a NAT, they can still open connections to one another.</p>
<p>66<br>00:04:52,000 –&gt; 00:04:57,000<br>And, middlely, through a third host that is, it does have a publicly routed polypy address,</p>
<p>67<br>00:04:57,000 –&gt; 00:05:00,000<br>and which is not sitting behind a NAT.</p>
<p>68<br>00:05:00,000 –&gt; 00:05:05,000<br>So, that’s some basic things that you can do, say, at the TCP level, and etc.</p>
<p>69<br>00:05:05,000 –&gt; 00:05:08,000<br>It turns out that if you really need to open up direct connections,</p>
<p>70<br>00:05:08,000 –&gt; 00:05:13,000<br>there are more aggressive and tricky things you can do,</p>
<p>71<br>00:05:13,000 –&gt; 00:05:17,000<br>one of which is called NAT hole punching.</p>
<p>72<br>00:05:17,000 –&gt; 00:05:22,000<br>And so, the basic idea here is that we have these two clients that are sitting behind NATs,</p>
<p>73<br>00:05:22,000 –&gt; 00:05:26,000<br>client A and client B, and they want to open up direct connections to one another,</p>
<p>74<br>00:05:26,000 –&gt; 00:05:28,000<br>or a direct connection between each other.</p>
<p>75<br>00:05:28,000 –&gt; 00:05:32,000<br>They don’t want to go through some external rendezvous service or relay.</p>
<p>76<br>00:05:32,000 –&gt; 00:05:41,000<br>And so, what they do is they first talk with some external server to figure out what, you know, some citizen server here,</p>
<p>77<br>00:05:41,000 –&gt; 00:05:44,000<br>to figure out what their external address and ports are.</p>
<p>78<br>00:05:44,000 –&gt; 00:05:51,000<br>So, client B says, a half, I send you packets, say, from UDP port 6,000.</p>
<p>79<br>00:05:51,000 –&gt; 00:05:55,000<br>The server will then report back to the mesh saying, aha, well, these packets you’re sending,</p>
<p>80<br>00:05:55,000 –&gt; 00:06:02,000<br>I see them coming from 76, 18, 117, 20 port, 90, 91.</p>
<p>81<br>00:06:02,000 –&gt; 00:06:13,000<br>So, the client B knows that 10.1.1.9 port 6,000 appears externally to the world as 76, 18, 17, 20, 90, 91.</p>
<p>82<br>00:06:13,000 –&gt; 00:06:16,000<br>And A does the same thing.</p>
<p>83<br>00:06:16,000 –&gt; 00:06:28,000<br>So, it’ll find out that, you know, its packets look like 34.22.8 port 30,000 and 5.</p>
<p>84<br>00:06:28,000 –&gt; 00:06:40,000<br>So, now, in these cases, both clients A and B have sent packets over the NAT from this internal address port pair to this two and external IP address on port.</p>
<p>85<br>00:06:40,000 –&gt; 00:06:48,000<br>And the NATs have created Mappings. So, they have Mappings internally for this internal address port.</p>
<p>86<br>00:06:48,000 –&gt; 00:06:53,000<br>And let’s just say that they’re full-coned NATs, just for simplicity’s sake.</p>
<p>87<br>00:06:53,000 –&gt; 00:06:56,000<br>This means that these Mappings are now active on the NATs.</p>
<p>88<br>00:06:56,000 –&gt; 00:07:05,000<br>So, it’s possible now if communicating with a server, client B can ask the server, hey, what’s client A’s public IP address in port?</p>
<p>89<br>00:07:06,000 –&gt; 00:07:13,000<br>Based on that, the server could say, oh, well, it’s 128, 34, 22, 8 port 30,000 and 5.</p>
<p>90<br>00:07:13,000 –&gt; 00:07:26,000<br>Ah, then client B could send traffic to that public IP address in port pair and it could diverse the NAT mapping.</p>
<p>91<br>00:07:27,000 –&gt; 00:07:42,000<br>Similarly, A could ask the server, hey, what’s B’s, I public IP address in port pair, then send traffic to 76, 18, 17, 20, port 90, 91 and have it traverse the Mapping and go to client B.</p>
<p>92<br>00:07:42,000 –&gt; 00:07:48,000<br>This is assuming that those Mappings are full-cones or full-coned NATs. Let’s say that they’re not full-coned NATs.</p>
<p>93<br>00:07:49,000 –&gt; 00:07:59,000<br>Well, it turns out you can still do some tricks where the server can tell client A and client B again what the public IP address port pairs are of the other clients.</p>
<p>94<br>00:07:59,000 –&gt; 00:08:03,000<br>And then the clients can try sending traffic to each other simultaneously.</p>
<p>95<br>00:08:03,000 –&gt; 00:08:11,000<br>And so, client B will start sending traffic to 128, 34, 22, 8 port 30,000 and 5 from its port 6,000.</p>
<p>96<br>00:08:11,000 –&gt; 00:08:20,000<br>So, simultaneously, client A will start sending traffic to 76, 18, 17, 20, port 90, 91 from its IP address and port.</p>
<p>97<br>00:08:20,000 –&gt; 00:08:31,000<br>What’s going to happen is that if we say had a restricted-coned NAT or even a port restricted NAT, when those packets, those outgoing packets traverse the NAT, the NAT’s going to set up a Mapping.</p>
<p>98<br>00:08:31,000 –&gt; 00:08:41,000<br>So, I’m going to say, aha, I see that you client A are sending traffic to this external IP address and port. I’ll create a Mapping for you so things are translated properly.</p>
<p>99<br>00:08:41,000 –&gt; 00:08:45,000<br>Similarly, this NAT on the right is going to do when client B sends the traffic.</p>
<p>100<br>00:08:45,000 –&gt; 00:08:53,000<br>And so, by knowing what the external address and ports are of the other side, they can force the NAT to set up a Mapping.</p>
<p>101<br>00:08:53,000 –&gt; 00:09:17,000<br>So, one question is, is there a kind of NAT or what kinds of NATs would this NAT work for? This model where client A and client B simultaneously send traffic to the external IP address and port that Mapp to an internal IP address and port on each of these clients, which are determined earlier by communicating with the server.</p>
<p>102<br>00:09:17,000 –&gt; 00:09:25,000<br>So, giving me these different kinds of NATs, is there a kind of NAT for which this would not work?</p>
<p>103<br>00:09:25,000 –&gt; 00:09:32,000<br>So, it turns out this will work for full-coned NATs because the Mappings will work fine even if the source, IGP, address and port are different.</p>
<p>104<br>00:09:32,000 –&gt; 00:09:40,000<br>Work for restricted-coned NATs because again, we’ve set up these Mappings, which will include the external IP address of the other NAT.</p>
<p>105<br>00:09:40,000 –&gt; 00:09:47,000<br>It will work for port restricted NATs because again, these packets are coming from the right UDP ports.</p>
<p>106<br>00:09:47,000 –&gt; 00:09:59,000<br>The one class of NAT it won’t work for is a symmetric NAT because when these clients talk to the server to figure out their IP address and port, their external ones, that Mapping won’t hold when they start talking to another NAT.</p>
<p>107<br>00:09:59,000 –&gt; 00:10:12,000<br>So, just because the server saw port 30,000 and five, when client A then tries to send traffic to the NAT on the right, the NAT is not going to reuse port 30,000 and five.</p>
<p>108<br>00:10:12,000 –&gt; 00:10:15,000<br>It’s going to allocate a new external port and so it won’t work.</p>
<p>109<br>00:10:15,000 –&gt; 00:10:19,000<br>So, this one reason why symmetric NATs are really frowned upon in the Internet today.</p>
<p>110<br>00:10:20,000 –&gt; 00:10:30,000<br>So, talk about implications of NATs to applications and how they have to do things to set up Mappings or either these relays or rendezvous services.</p>
<p>111<br>00:10:30,000 –&gt; 00:10:36,000<br>So, there’s another, perhaps even deeper, implication of NATs, which is to transport.</p>
<p>112<br>00:10:36,000 –&gt; 00:10:44,000<br>So, if you think for a second, for a NAT to set up a Mapping, it needs to know what the transport protocol is.</p>
<p>113<br>00:10:44,000 –&gt; 00:10:51,000<br>It needs to know the transport protocol is header. So, for example, when it sets up a UDP or TCP Mapping, the NAT needs to know that this is a TCP segment.</p>
<p>114<br>00:10:51,000 –&gt; 00:10:59,000<br>This is a UDP segment. This is where the port number is in that segment. This is what I need to rewrite. This checksums are calculated.</p>
<p>115<br>00:10:59,000 –&gt; 00:11:11,000<br>And without that, it can’t do it. So, if you deploy, if you say write a new transport protocol that uses a transport protocol identifier in an IP packet, and you try to get it to version that, and that will discard it.</p>
<p>116<br>00:11:11,000 –&gt; 00:11:20,000<br>It doesn’t know the packet format. And so, in this way, you can’t really deploy a new transport protocol on the Internet today.</p>
<p>117<br>00:11:20,000 –&gt; 00:11:30,000<br>There’s a chicken and egg problem where the people developing NAT software and maintaining the NAT software will not add support for a new transport protocol until it’s very, very popular.</p>
<p>118<br>00:11:30,000 –&gt; 00:11:34,000<br>But it won’t become very popular until it works across NATs.</p>
<p>119<br>00:11:35,000 –&gt; 00:11:48,000<br>And so, there’s this debate and philosophical discussion, and so the early mid-2000s about how NATs mean that we’re basically stuck with TCP UDP and ICMP.</p>
<p>120<br>00:11:48,000 –&gt; 00:11:55,000<br>To have an application work for real on the Internet at large, it has to use one of those three transport protocols.</p>
<p>121<br>00:11:55,000 –&gt; 00:12:01,000<br>And so, really, when that’s today, we’re not going to see any new transport protocols on the Internet.</p>
<p>122<br>00:12:01,000 –&gt; 00:12:06,000<br>And so, this leads to this really big philosophical debate, especially occurring as NAT deployed in the early 2000s.</p>
<p>123<br>00:12:06,000 –&gt; 00:12:11,000<br>About on one hand, NATs are standingly useful. You can reuse addresses. They’re security.</p>
<p>124<br>00:12:11,000 –&gt; 00:12:23,000<br>If I’m sitting behind a NAT, and I happen to have some vulnerable open ports and my Linux machine or my Windows machine, since there’s no mapping, attackers from outside on the Broad Internet can’t compromise me.</p>
<p>125<br>00:12:24,000 –&gt; 00:12:32,000<br>It sort of gives this very simple, very sledgehammering, but very effective just for users and users’ security.</p>
<p>126<br>00:12:32,000 –&gt; 00:12:41,000<br>Not opening connections can be good. But there’s also tremendously painful, especially before NATs start to have standard behavior.</p>
<p>127<br>00:12:41,000 –&gt; 00:12:50,000<br>Developing applications is really hard. Imagine if somebody calls you and says, hey, your application doesn’t work. Sometimes the connection drops.</p>
<p>128<br>00:12:50,000 –&gt; 00:13:03,000<br>And it could be something like it happens to be that when the client is transitioning from one server to another, and that NAT is using a symmetric NAT, such that the ports are being reallocated and the connection breaks.</p>
<p>129<br>00:13:03,000 –&gt; 00:13:05,000<br>Really hard to debug.</p>
<p>130<br>00:13:05,000 –&gt; 00:13:13,000<br>And so, one example, there’s this really famous example, something called Speak Freely, which is this pre-sky voiceover IP.</p>
<p>131<br>00:13:13,000 –&gt; 00:13:20,000<br>Basically, the guy said, hey, I’m going to stop developing Speak Freely because it just doesn’t work under NATs, and there’s no way to make them work with NATs.</p>
<p>132<br>00:13:20,000 –&gt; 00:13:25,000<br>There’s before people figure out all the hole punching and before the behavior is standard enough to do so.</p>
<p>133<br>00:13:25,000 –&gt; 00:13:30,000<br>And so there’s this huge philosophical debate. Now, it’s good and that’s bad. They break the end to end argument.</p>
<p>134<br>00:13:30,000 –&gt; 00:13:37,000<br>But really, it’s very interesting, but it turns to be pointless. I mean, NATs are here to stay. They’re deployed. They’ll always be deployed.</p>
<p>135<br>00:13:37,000 –&gt; 00:13:46,000<br>Their advantages generally are considered to outweigh the disadvantages. People are in deployment, and they want them to work, and you have to work around them.</p>
<p>136<br>00:13:46,000 –&gt; 00:13:58,000<br>But so what this means is that we historically talk about the internet as having a narrow waste that IP. There’s a single unifying protocol, which then allows you to have many transfer protocols above, many linked protocols below.</p>
<p>137<br>00:13:58,000 –&gt; 00:14:00,000<br>But NATs have changed that.</p>
<p>138<br>00:14:00,000 –&gt; 00:14:07,000<br>So really, in a practical sense, the new hourglass includes not only layer three, but also layer four.</p>
<p>139<br>00:14:07,000 –&gt; 00:14:13,000<br>Because for practical concerns, we’re not going to see new transport protocols implemented or deployed.</p>
<p>140<br>00:14:13,000 –&gt; 00:14:17,000<br>You can build protocols on top of UDP, and that’s generally what’s done today.</p>
<p>141<br>00:14:17,000 –&gt; 00:14:27,000<br>GDP just provides a nice data-gram service rather than using a transport identifier at three at layer three. You use a port at layer four.</p>
<p>142<br>00:14:27,000 –&gt; 00:14:37,000<br>But this is the world as it is that now the new hourglass of the internet, because of network address translation, is IP, then with ICMP, TCP, and UDP.</p>
<p>143<br>00:14:37,000 –&gt; 00:14:44,000<br>So you can see how this technology actually just caused an architectural shift within the internet within the past decade.</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CS144 NetworkP705 3NATs</div>
      <div>http://example.com/2025/10/23/CS144-networkP705-3NATs/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年10月23日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/10/23/CS144-networkP675-0ApplicationsandNATs/" title="CS144 NetworkP675 0ApplicationsandNATs">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">CS144 NetworkP675 0ApplicationsandNATs</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/10/23/CS144-networkP695-2NATs/" title="CS144 NetworkP695 2NATs">
                        <span class="hidden-mobile">CS144 NetworkP695 2NATs</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
