---
title: 计算机网络 037 Principles Packet Switching How a packet switch works(1)
date: 2025-10-19 10:00:36
---

发言人   00:00
To continue on our theme of packet switching, in this video I'm going to tell you how packet switches work. That's things like ethernet switches, internet routers, and so on. In this video, we're going to learn about what a packet switch looks like, what a packet switch does, whether it's an Ethernet switch or an e.t. router, and how address lookups work. So let's start with a picture of a generic packet switch. 
为了继续讨论分组交换的主题，在本视频中，我将告诉您分组交换的工作原理。比如以太网交换机、互联网路由器等等。在本视频中，我们将了解分组交换机的外观，分组交换机的作用，无论是以太网交换机还是以太网交换机。 路由器，以及地址查找的工作原理。所以，让我们从一个通用分组交换机的图片开始。



发言人   00:28
The three main stages of a packet switch are when a packet arrives. The first thing that we do is look up at the address. This means looking at the destination address to figure out where it's going to go next. We do this by looking up in a forwarding table. We send the destination address down to the forwarding table, which will tell us the egress link or the port that it's going to, and that helps us decide where to send it next. The next thing that we may need to do is to update the header. So for example, if it's an internet router, we have to decrement the TTT TTL and update the checksum. 
数据包交换的三个主要阶段是数据包到达的时间。我们做的第一件事就是查看地址。这意味着要查看目标地址以确定它下一步要去哪里。我们通过查找转发表来实现这一点。我们将目标地址发送到转发表，转发表会告诉我们出口链接或端口，这有助于我们决定下一步将其发送到哪里。我们可能需要做的下一件事是更新标题。因此，例如，如果它是一个互联网路由器，我们必须减少TTT TTL并更新校验和。



发言人   01:02
The next thing we have to do is to queue the packet. This is because there may be some congestion, there may be many packets trying to get to this outgoing link at the same time. So we use a buffer memory to hold some packets that are awaiting their turn to depart on the egress line. Of course, this one input, 1 output packet, which is not very interesting. Packet switches in general will have multiple inputs and multiple outputs. 
我们接下来要做的是对数据包进行排队。这是因为可能存在一些拥塞，可能有许多数据包同时尝试到达此出站链接。因此，我们使用缓冲内存来保存一些等待轮到它们在出口线上离开的数据包。当然，这个一个输入，一个输出的数据包，不是很有趣。一般来说，分组交换机会有多个输入和多个输出。


发言人   01:27
Here's one with three inputs and 3 outputs. Packets will arrive, and I've color coded these ones. The red packets are going to the red output over here, and the blue 1 is going to the blue output here. So just as before, the packets are going to be processed, the address is going to be looked up, we're going to update the header if we need to, then we're going to transfer it across that backplane. This is supposed to represent a shared bus over which all of these packets are going to pass, and then they're going to find their way to the output queue. 
这是一个具有三个输入和三个输出的。包裹将会到达，我已经对这些包裹进行了颜色编码。红色数据包将发送到这里的红色输出，而蓝色的1将发送到这里的蓝色输出。所以和以前一样，数据包将被处理，地址将被查找，如果需要我们将更新标头，然后我们将通过该底板传输它。这应该代表一个共享总线，所有这些数据包将通过该总线，然后它们将找到自己的输出队列。

发言人   01:59
In this case, we've got two red packets that are going to contend for the same output. So what we'll need to do is we can send the blue 1 to its output. We can send one of the red ones all the way through to its output. But because we can only send one packet at a time, the other red packet is going to have to wait in the buffer memory until the until the first one is gone. Once it's gone, this one can go on its way. 
在这种情况下，我们有两个红包要竞争相同的输出。所以我们需要做的是将蓝色的1发送到它的输出。我们可以将其中一个红色的一直发送到它的输出。但是因为我们一次只能发送一个数据包，另一个红包将不得不在缓冲区内存中等待，直到第一个红包消失。一旦它走了，这个就可以继续前进。

发言人   02:24
So this is sort of the generic structure of a packet switch. More specifically, one very common type of packet switch is an Ethernet switch. These are the four basic operations that an Ethernet switch must perform. 
这是一种分组交换机的通用结构。更具体地说，一种非常常见的分组交换类型是以太网交换机。以下是以太网交换机必须执行的四种基本操作。


发言人   02:39
So it's an Ethernet switch is an example of a packet switch, it's just a very specific one that's dealing with ethernet ethernet frames. So the first thing it does is it examines the header of each arriving frame. If the Ethernet destination address, if the destination address, and these are 48 b addresses with Ethernet, if it finds that address in the forwarding table, it's going to forward the frame to the correct outgoing port or maybe a selection of ports, if it's a multicast packet, if it finds that the Ethernet destination address is not in the table in an Ethernet switch, it broadcasts the frames to all ports, well, all ports except the one through which the frame arrived. In other words, it doesn't know where to send it, so it's going to flood it to everybody in the hope that it'll reach its destination. 
所以它是一个以太网交换机，是分组交换机的一个例子，它只是一个非常具体的处理以太网帧的交换机。所以它做的第一件事是检查每个到达帧的标题。如果是以太网目标地址，如果是目标地址，并且这些是带有以太网的48个地址，如果在转发表中找到该地址，它将把帧转发到正确的传出端口或端口选择，如果是多播数据包，如果它发现以太网目标地址不在以太网交换机的表中，它会将帧广播到除帧到达的端口之外的所有端口。换句话说，它不知道把它发送到哪里，所以它会把它淹没给每个人，希望它能到达目的地。

发言人   03:31
How does it populate the table in the first place? Well, it does this by learning addresses that it sees on the wire. More specifically, when a packet arrives, the entries in the table are learned by examining the Ethernet source address of a raving packets. So when packets first come through, the destination address is not in the table. It's broadcast to everybody. Hopefully the other end will respond, send a packet back, we'll see its source address, and we will therefore learn that in future, we must send packets through that particular port to reach that particular address. So these are the four basic operations of an Ethernet switch. 
它首先如何填充表格？它通过学习在线路上看到的地址来做到这一点。更具体地说，当数据包到达时，通过检查狂乱数据包的以太网源地址来学习表中的条目。因此，当数据包首次通过时，目标地址不在表中。它向所有人广播。希望另一端会响应，发送一个数据包，我们会看到它的源地址，因此我们将了解到将来必须通过该特定端口发送数据包才能到达该特定地址。以下是以太网交换机的四种基本操作。

发言人   04:10
Let's contrast that with an Internet router, another type of packet switch which processes internet the IP destination address instead. So there's 7 basic operations because it's dealing with IP datagrams that are encapsulated in Ethernet packets. 
让我们将其与互联网路由器进行对比，这是另一种类型的数据包交换机，它处理互联网的IP目标地址。因为它处理封装在以太网数据包中的IP数据报，所以有7个基本操作。


发言人   04:29
First of all, it's going to check to see whether the Ethernet destination address of the arriving frame belongs to the router. In other words, is it's addressed to this router, if it is, it accepts it. If it doesn't, it drops it because it's clearly not destined for us. The next thing it does is to check that the IP version number is 4 if it's an Ipv 4 router and checks the length of the datagram. Next, it's going to decrement the TTL and update the IP header checksum because the checksum includes the TTL, it checks to see if the TTL equals 0. If it does, it drops the packet. If it doesn't, then it can continue to forward it. 
首先，它将检查到达的帧的以太网目的地址是否属于路由器。换句话说，如果它是发送到此路由器的，如果是，它会接受它。如果它没有，它会掉落，因为它显然不是注定要给我们的。下一件事是检查IP版本号是否为4，如果是Ipv 4路由器，并检查数据报的长度。接下来，它将减少TTL并更新IP标头校验和，因为校验和包括TTL，它检查TTL是否等于0。如果是，它会丢弃数据包。如果它不这样做，那么它可以继续转发它。

发言人   05:12
Next, it's going to look up in the forwarding table if the IP destination address is in the forwarding table, it's going to forward it to the correct egress port or ports, so if it's multicast and this is the correct ports to reach the next hop, because IP is doing hop by hop routing, now it's decided which port it's going to depart from. It encapsulates the IP datagram back into an ethernet frame, and it has to figure out the correct ethernet destination address to use for the next top router. We'll learn this process later, it's called ARP, and so it'll encapsulate the IP datagram into the Ethernet frame, create the new Ethernet frame, and then send it onto the wire. 
接下来，如果IP目标地址在转发表中，它将在转发表中查找，它将把它转发到正确的出口端口或端口，因此，如果它是多播并且这是到达下一跳的正确端口，因为IP正在进行逐跳路由，现在已经决定从哪个港口出发。它将IP数据报封装回以太网帧中，并且必须确定要用于下一个顶级路由器的正确以太网目标地址。我们稍后会学习这个过程，它被称为ARP，因此它会将IP数据报封装到以太网帧中，创建新的以太网帧，然后将其发送到线路上。


发言人   05:58
So the basic operations of a packet switcher to look up the address token, ask the question, how is this address looked up in the forwarding table? I'm going to show you some examples in the moment. The second operation is switching, once it's figured out which egress port it needs to go to, it now has to send it to that correct output. It's got to deliver it to that correct output port so it can leave on the correct outgoing link. 
因此，数据包切换器查找地址令牌的基本操作，请提出问题，如何在转发表中查找此地址？我现在要给你看一些例子。第二个操作是切换，一旦确定了需要转到哪个出口端口，现在必须将其发送到正确的输出端口。它必须将其传送到正确的输出端口，以便可以离开正确的出站链接。

发言人   06:21
I'm going to start with the lookup address, and then in the next video, we're going to learn about switching. So for Ethernet switches, looking up the address is very straightforward. 
我将从查找地址开始，然后在下一个视频中，我们将学习切换。因此，对于以太网交换机，查找地址非常简单。


发言人   06:35
It will have a forwarding table, which I've drawn in a very simplified form here. This is the match that it's going to perform. This is what it's going to try and match the Ethernet destination address on, and this is then the action it's going to perform. If it finds a match, If an incoming Ethernet frame has a destination address that matches this one here, then it's going to forward it to port 7. If it matches on this address here, then it's going to forward it to port 3. 
它将有一个转发表，我在这里画了一个非常简化的形式。这就是它将要进行的比赛。这就是它将尝试匹配以太网目标地址的内容，然后这就是它将执行的操作。如果它找到了匹配的地址，如果一个传入的以太网帧的目的地址与此匹配，那么它将把它转发到端口7。如果它在此地址上匹配，那么它将把它转发到端口3。

发言人   07:05
I've just drawn the 48 b addresses here as hexadecimal numbers. Okay, so the Ethernet forwarding table has a number of rows, one for each address. For each address, it's going to tell it which port that it needs to forward to. And if it misses, then it broadcasts because that's what Ethernet switches do when they don't know the address to send it to. 
我刚刚将这里的48个b地址绘制为十六进制数字。好的，所以以太网转发表有许多行，每个地址对应一行。对于每个地址，它将告诉它需要转发到哪个端口。如果它错过了，那么它就会广播，因为以太网交换机在不知道要发送到的地址时就是这样做的。

发言人   07:29
Now, to do this lookup, the way that it performs this lookup is that typically it stores these addresses in a hash table because these are 48 b addresses, but there's nothing linked two to the 48 entries. There maybe 100000, maybe even 1 million ins. So nothing like two to the power of 48. So it's a very sparse table. So typically they store addresses in a hash table might be a two way hash to increase the probability of having a hit on on the on the first try. And then it will look up the map by looking for an exact match in the hash table. In other words, it's looking for an exact match on the 48 b address. So that's how address lookups are done in an ethernet switch. 
现在，要进行此查找，它执行此查找的方式通常是将这些地址存储在哈希表中，因为这些是48个地址，但没有任何东西将两个链接到这48个条目。可能有十万，甚至可能是一百万。所以没有什么比2的48的幂。所以这是一个非常稀疏的表。因此，通常它们将地址存储在哈希表中，可能是双向哈希，以增加在第一次尝试时命中的概率。然后它将通过在哈希表中查找精确匹配来查找地图。换句话说，它正在寻找48 b地址的精确匹配。这就是在以太网交换机中进行地址查找的方式。

发言人   08:11
Now let's look at how they're done in an IP router and an internet address. Internet router. So IP addresses are a bit more complicated, IP addresses, we don't just look up on an exact match. We look up on what's called a longest prefix match. We'll learn about why that is later when we learn about IP addresses, but suffice to know right now we're performing a longest prefix match rather than an exact match. 
现在让我们看看它们在IP路由器和互联网地址中是如何完成的。互联网路由器。所以IP地址有点复杂，我们不只是查找完全匹配的IP地址。我们查找所谓的最长前缀匹配。我们将在稍后了解IP地址时了解为什么，但现在足以知道我们正在执行最长的前缀匹配而不是精确匹配。


发言人   08:38
So just as before, we've got some matches here of some IP prefixes. And I'll tell you what those are in a moment. And then this is the action that we would perform. 
所以和以前一样，我们这里有一些匹配的IP前缀。我一会儿会告诉你这些是什么。然后这就是我们要执行的行动。

发言人   08:49
So for example, if we, if we had a match on this IP destination address, this one here, and this is a specific IP destination address, 127 dot 4 3.5 7.99. So that'll be a 32 b address. We're going to forward it to this IP address. So this is actually the IP address of the interface of the next router that we're going to after it's made this decision, it's going to resolve this. It's going to turn this IP address into the equivalent Ethernet destination address of that interface so that it knows what to encapsulate the packet into. But anyway, for inside the forwarding table, it maintains it as an IP address. 
因此，例如，如果我们在此IP目标地址上有一个匹配，那么这里的这个就是一个特定的IP目标地址，127点4 3.5 7.99。所以这将是一个32 b的地址。我们将把它转发到这个IP地址。所以这实际上是我们下一台路由器的接口的IP地址，在它做出这个决定后，它将解决这个问题。它会将此IP地址转换为该接口等效的以太网目标地址，以便知道将数据包封装到什么位置。但无论如何，在转发表内部，它将其维护为IP地址。

发言人   09:30
So if we see something that matches here, then this is the action that we perform. So let's look at what a longest prefix match is. Along here I've got the IP version for address number line. In other words, all of the possible two to the 32 different addresses that we can have in an IP destination address. And what I've got up here are some line segments. These line segments are prefixes and they're always represented as in the following form. 
所以，如果我们在这里看到匹配的东西，那么这就是我们执行的操作。那么让我们看看最长的前缀匹配是什么。在这里，我有地址号码行的IP版本。换句话说，我们可以在IP目标地址中拥有的所有可能的两个到32个不同的地址。我在这里得到的是一些线段。这些线段是前缀，它们总是用以下形式表示。


发言人   10:05
This line segment here corresponds to all of the addresses that start with 65. The interpretation of this is all of those with 65 as the first 8 b. So a, if a packet, an incoming destination address, has 65 as the first 8 b of address, then it's going to match on this line segment. And this line segment represent all the IP addresses. Let's start with 65 in the first 8 b locations. Similarly, this line segment here corresponds to all of the IP addresses that their first 16 b are 128.9. So there are two to the power of 16 addresses here, all with the first 16 b, 128.9. And so we represent that prefix as 1, 2, eight point 9.00 slash 16, corresponding to those first 16. 
此线段对应所有以65开头的地址。对此的解释是所有以65为前8 b的人。所以，如果一个数据包，一个传入的目的地址，有65个作为地址的前8 b，那么它将在这个线段上匹配。这条线段代表所有的IP地址。让我们从前8 b个地点的65个开始。同样，这里的这段线段对应于其前16个地址为128.9的所有IP地址。所以这里有两个16的幂的地址，全部用前16个b，128.9。因此我们将该前缀表示为1，2，八点9.00斜杠16，对应于前16个。

发言人   11:01
Finally, one more example, this one up here, which is a very short line segment, is all those addresses that share the first 24 b. This means there are two to the eight of them, or 256 different addresses that all start with 128 dot 9.176. 
最后，再举一个例子，这里的这个，是一个非常短的线段，是所有共享前24个b的地址。这意味着有两到八个地址，或者说256个不同的地址，都以128点9.176开头。

发言人   11:18
Okay, so when a packet arrives with a particular destination address, and here's an example here, this one is clearly going to match on this line segment right here. So this is the address on the number line. This is where it matches here, so that we know that the prefix that we've matched onto the table is this one. So the table will contain this entry here. This address will match on this entry in the table. 
好的，所以当一个数据包到达一个特定的目标地址时，这里有一个例子，这个地址显然会在这里的这段线段上匹配。所以这是号码行上的地址。这就是它在这里匹配的地方，这样我们就知道我们匹配到表格上的前缀是这个。因此，表格将在此处包含此条目。此地址将匹配表中的此条目。

发言人   11:46
Similarly, this address 128 dot 9 dot one dot 1 4 is going to match on this line segment here. Notice that it matched on this one, but this one is A is a longer matching pre more of the bits match on this one than they do on this one. This is a longer prefix, it's 20 two-one bits prefix, whereas this one is only a 16 b prefix. So because it matches on both, and this is the longest one, the address, this address here will match on this prefix here in the table. 
同样，这个地址128点9点1点4将在这里的线段上匹配。请注意，它在这个匹配上，但是这个A是一个更长的匹配，pre比这个上的更多的位匹配。这是一个更长的前缀，它是20位二进制前缀，而这只是一个16位的前缀。因此，因为它匹配两个地址，并且这是最长的地址，这里的这个地址将匹配表格中的这个前缀。

发言人   12:19
So in routing lookups, what we do is we find the longest matching prefix, also known as the most specific route amongst all the prefixes that match the destination address. Let's look at how we might implement this in a table. And one common implementation is to use what's called a binary tri trie. And there are many variations of this, but this is the most common one here. 
因此，在路由查找中，我们要做的是找到最长的匹配前缀，也称为与目标地址匹配的所有前缀中最具体的路由。让我们看看如何在一个表中实现它。一个常见的实现是使用所谓的二进制trrie。这有许多变化，但这是这里最常见的。


发言人   12:48
Let's say that we had a prefix table that look like this. This prefix table is a bit strange because all the prefixes are very short. I'm just doing that so that they can be clearly represented in this table. So I've got 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 different entries in the table, and I'm going to populate them on this try right here because the matching of an incoming address is going to have variable length, we need a data structure to hold variable length entries. 
假设我们有一个看起来像这样的前缀表。这个前缀表有点奇怪，因为所有的前缀都非常短。我这样做只是为了让它们能够在这个表格中清晰地呈现出来。所以我在表格中有1，2，3，4，5，6，7，8，9，10个不同的条目，我将在这里尝试填充它们，因为传入地址的匹配将具有可变长度，我们需要一个数据结构来保存可变长度的条目。

发言人   13:20
So the way that this data structure holds these entries is let's take the 0 0, 0 0 1, this is 0, this is 0, this is 0, this is 0, and then this is one. In other words, we take the left branch for a 0, and the right branch for a one. And so we encode or store this entry A at this particular leaf corresponding to that entry. And similar at the other extreme, let's take a look at J, that's 1 1 1 1 0, 0 0 0, corresponding to this entry here. And this is where we'll find j at the leaf once we've got this data structure for storing the entries when a packet comes in with a particular destination address, we can just do a bit by bit comparison. 
因此，这个数据结构保存这些条目的方式是，让我们取0 0，0 0 1，这是0，这是0，这是0，然后这是1。换句话说，我们将左边的分支设置为0，右边的分支设置为1。因此，我们在与该条目相对应的这个特定叶中编码或存储该条目A。在另一个极端类似的情况下，让我们来看一下J，它是1 10，0，与这里的条目相对应。一旦我们有了用于存储条目的数据结构，当数据包以特定的目的地址进入时，我们就会在叶子处找到j，我们可以进行逐位比较。

发言人   14:04
Traverse is tree, and it will tell us which entry is the longest matching prefix. If we get to a leaf and find that there's nothing there, we go share to the nearest matching one that shared bits in common with that address. You might want to experiment with this, with these other entries in the table. So this is one common way of storing and performing the lookup in the for A, for a longest matching prefix. 
遍历是树，它会告诉我们哪个条目是最长的匹配前缀。如果我们到达一个叶子并发现那里什么都没有，我们就会去共享与该地址共享相同位的最近的匹配地址。您可能想要尝试一下，使用表格中的这些其他条目。所以这是一种常见的存储和执行查找的方法，对于最长的匹配前缀。

发言人   14:27
And there's another entry, another mechanism which is quite commonly used too, that's to use a special type of memory device called a ternary content addressable memory, or a TCAM and a TCAM. 
还有另一个条目，另一种常用的机制，那就是使用一种特殊类型的存储设备，称为三元内容可寻址内存，或TCAM和TCAM。

发言人   14:39
Here's the table again that we had, that we had before. And we start by storing it in a slightly different representation in the table. So entry A would be stored as four zeros and a 1, And here we've rounded everything out to 8 b as if they're 8 b, 8 b prefixes. And this mask value here is telling us which bits in the value above actually matter. So wherever there was a 0 or one, we put a one to say these are all valid. And wherever we have an x, we put a 0. So these 2 b, these two representations here, we can either think of them as a ternary value or two binary values that are storing this entry. They tell us which bits of which values and which ones don't matter. 
这又是我们之前的那张桌子。我们首先将它存储在表中略有不同的表示形式中。因此，条目A将被存储为四个零和一个1，在这里，我们将所有内容四舍五入为8 b，就好像它们是8 b，8 b的前缀一样。这里的掩码值告诉我们上面值中的哪些位实际上很重要。所以无论哪里有0或1，我们都会放一个来说明这些都是有效的。无论我们有一个x，我们都会放一个0。所以这两个表示形式，我们可以将它们看作是三值或两个存储此条目的二进制值。它们告诉我们哪些值位和哪些不重要。


发言人   15:25
So the process of performing a lookup is kind of brute force. We compare an incoming address against every masked entry at the same time in parallel on the table. So these specialized members consume quite a bit of power because they're doing all of that at the same time, But they can be really, really fast. And so they're quite commonly used for doing longest prefix matches in routers. 
因此，执行查找的过程有点像暴力破解。我们将传入地址与表格上的每个掩码条目同时并行比较。这些专门的成员消耗了相当多的能量，因为他们同时做所有这些，但他们可以非常非常快。因此，它们通常用于在路由器中进行最长的前缀匹配。

发言人   15:48
One of the last thing I wanted to point out is there's a sort of an increasing interest these days in what we might call generic lookups. You know, I made the observation before that these tables are holding a match field and an action field. And so we can generalize this or abstract this and say pretty much any packet switch is doing a lookup, which is a match followed by an action. And the match might be on any fields like an IP address or Ethernet destination address and an IP address if we wanted. And we might have actions like forward or drop or encapsulate or do other things like the specific of a packet switch. 
我想指出的最后一件事是，现在人们对我们可以称之为通用查找的兴趣越来越大。你知道，我之前观察到这些表包含一个匹配字段和一个操作字段。所以我们可以概括这个或抽象这个，并说几乎任何数据包交换机都在进行查找，这是一个匹配后面跟着一个动作。如果我们愿意，匹配可能在任何字段上，如IP地址或以太网目标地址以及IP地址。并且我们可能会进行转发、丢弃、封装或执行其他操作，例如特定的数据包交换。


发言人   16:28
Nowadays, packet switches are designed that can do all sorts of different types of forwarding for layer 2, layer 3 at the same time. Or they could be, they could be for things like switches, routers, firewalls, all sorts of devices like that. So in summary, packet switches perform two basic operations. They perform the lookups for looking up addresses in a forwarding table, and then they switch the packet to the correct outgoing port. At high level. Ethernet switches and Internet routers perform very similar operations. They basically processing these packets in a very similar way. Address lookup is different in switches and routers, and we saw some examples of those for both Ethernet addresses and IP addresses. That's the end of this video. 
现在，分组交换机被设计成可以同时为第2层和第3层进行各种不同类型的转发。或者它们可以用于诸如交换机、路由器、防火墙等各种设备。总之，分组交换机执行两个基本操作。他们执行在转发表中查找地址的查找，然后将数据包切换到正确的输出端口。在高水平上。以太网交换机和互联网路由器执行非常相似的操作。他们基本上以非常相似的方式处理这些数据包。地址查找在交换机和路由器中是不同的，我们看到了一些以太网地址和IP地址的例子。这就是这个视频的结尾。